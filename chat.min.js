const chatMessages=document.getElementById("chatMessages"),chatUsername=document.getElementById("chatUsername"),chatMessage=document.getElementById("chatMessage"),chatSend=document.getElementById("chatSend"),chatToggle=document.getElementById("chatToggle"),chatSection=document.getElementById("chatSection"),savedUsername=localStorage.getItem("chatUsername");function getUsernameColor(e){const t=["#ff6b6b","#4ecdc4","#45b7d1","#ffa07a","#98d8c8","#f7dc6f","#bb8fce","#85c1e2","#f8b739","#6c5ce7"];let a=0;for(let t=0;t<e.length;t++)a=e.charCodeAt(t)+(a<<5)-a;return t[Math.abs(a)%t.length]}function formatTime(e){if(!e)return"";const t=e.toDate(),a=t.getHours().toString().padStart(2,"0"),s=t.getMinutes().toString().padStart(2,"0");return`${a}:${s}`}function addMessageToDOM(e,t,a){const s=document.createElement("div");s.className="chat-message";const n=getUsernameColor(e);s.innerHTML=`<div class="chat-message-user" style="color: ${n}">${e}</div><div class="chat-message-text">${t}</div><div class="chat-message-time">${formatTime(a)}</div>`,chatMessages.appendChild(s),chatMessages.scrollTop=chatMessages.scrollHeight}async function sendMessage(){const e=chatUsername.value.trim().toUpperCase(),t=chatMessage.value.trim();if(!e)return alert("Por favor ingresa tu nick"),void chatUsername.focus();if(!t)return;if(!window.chatDb)return void alert("Firebase no está configurado. Por favor sigue las instrucciones en firebase-config.js");try{const a=t;chatMessage.value="",await window.chatAddDoc(window.chatCollection(window.chatDb,"messages"),{username:e,message:a,timestamp:window.chatServerTimestamp()}),chatMessage.focus()}catch(e){console.error("Error al enviar mensaje:",e),alert("Error al enviar mensaje. Verifica que Firebase esté configurado correctamente."),chatMessage.value=t}}function startListeningToMessages(){if(!window.chatDb)return console.log("Esperando configuración de Firebase..."),void setTimeout(startListeningToMessages,1e3);try{const e=window.chatCollection(window.chatDb,"messages"),t=window.chatQuery(e,window.chatOrderBy("timestamp","desc"),window.chatLimit(50));window.chatOnSnapshot(t,e=>{chatMessages.innerHTML="";const t=[];e.forEach(e=>{t.push(e.data())}),t.reverse().forEach(e=>{addMessageToDOM(e.username,e.message,e.timestamp)})})}catch(e){console.error("Error al escuchar mensajes:",e)}}savedUsername&&(chatUsername.value=savedUsername),chatUsername.addEventListener("blur",()=>{if(chatUsername.value.trim()){const e=chatUsername.value.trim().toUpperCase();localStorage.setItem("chatUsername",e),localStorage.setItem("chatColor",getUsernameColor(e))}}),chatToggle.addEventListener("click",()=>{chatSection.classList.toggle("minimized"),chatToggle.textContent=chatSection.classList.contains("minimized")?"+":"—"}),chatSend.addEventListener("click",sendMessage),chatMessage.addEventListener("keypress",e=>{"Enter"===e.key&&sendMessage()}),window.addEventListener("load",()=>{setTimeout(startListeningToMessages,500)});
