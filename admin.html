<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - The Music Cave</title>
    <link rel="stylesheet" href="styles.min.css">
    <script src="custom-alert.js"></script>
    <style>
        .admin-container{max-width:900px;margin:100px auto;padding:2rem}
        .admin-header{margin-bottom:3rem;text-align:center}
        .admin-header h1{font-size:1.5rem;color:#999;letter-spacing:4px;margin-bottom:1rem}
        .login-form{max-width:400px;margin:0 auto;padding:2rem;border:1px solid #1a1a1a}
        .login-form input{width:100%;background:transparent;border:1px solid #1a1a1a;color:#999;font-family:'Courier New',monospace;font-size:.8rem;padding:.8rem;margin-bottom:1rem;letter-spacing:1px}
        .login-form input:focus{outline:none;border-color:#333}
        .login-form button{width:100%;background:transparent;border:1px solid #1a1a1a;color:#666;font-family:'Courier New',monospace;font-size:.8rem;padding:1rem;cursor:pointer;letter-spacing:3px;text-transform:uppercase;transition:all .3s}
        .login-form button:hover{border-color:#333;color:#999}
        .admin-content{display:none}
        .admin-content.active{display:block}
        .track-list{margin-top:2rem}
        .admin-track{background:#0a0a0a;border:1px solid #1a1a1a;padding:1.5rem;margin-bottom:1rem;display:flex;justify-content:space-between;align-items:center;gap:1rem}
        .track-info h3{color:#999;font-size:.9rem;font-weight:400;margin-bottom:.3rem;letter-spacing:1px}
        .track-info p{color:#444;font-size:.7rem;letter-spacing:1px}
        .track-platform-badge{display:inline-block;padding:.2rem .6rem;border:1px solid #1a1a1a;font-size:.6rem;color:#666;margin-top:.5rem;letter-spacing:2px}
        .delete-btn{background:transparent;border:1px solid #1a1a1a;color:#ff6b6b;font-family:'Courier New',monospace;font-size:.7rem;padding:.6rem 1.2rem;cursor:pointer;letter-spacing:2px;text-transform:uppercase;transition:all .3s}
        .delete-btn:hover{border-color:#ff6b6b;background:#ff6b6b;color:#000}
        .logout-btn{position:fixed;top:20px;right:20px;background:transparent;border:1px solid #1a1a1a;color:#666;font-family:'Courier New',monospace;font-size:.7rem;padding:.6rem 1.2rem;cursor:pointer;letter-spacing:2px;text-transform:uppercase;transition:all .3s}
        .logout-btn:hover{border-color:#333;color:#999}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
        .stat-card{background:#0a0a0a;border:1px solid #1a1a1a;padding:1.5rem;text-align:center}
        .stat-card h3{color:#444;font-size:.7rem;letter-spacing:2px;margin-bottom:.5rem;font-weight:400}
        .stat-card p{color:#999;font-size:2rem;letter-spacing:4px}
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Login Form -->
        <div class="login-form" id="loginForm">
            <div class="admin-header">
                <h1>ADMIN LOGIN</h1>
            </div>
            <input type="password" id="adminPassword" placeholder="Password" autocomplete="off">
            <button onclick="login()">ENTER</button>
        </div>

        <!-- Admin Content -->
        <div class="admin-content" id="adminContent">
            <button class="logout-btn" onclick="logout()">LOGOUT</button>

            <div class="admin-header">
                <h1>ADMIN PANEL</h1>
            </div>

            <div class="stats" id="stats">
                <div class="stat-card">
                    <h3>TOTAL TRACKS</h3>
                    <p id="totalTracks">...</p>
                </div>
                <div class="stat-card">
                    <h3>TOTAL LIKES</h3>
                    <p id="totalLikes">...</p>
                </div>
                <div class="stat-card">
                    <h3>TOTAL COMMENTS</h3>
                    <p id="totalComments">...</p>
                </div>
            </div>

            <h2 style="color:#666;font-size:.9rem;letter-spacing:3px;margin-bottom:1rem">MANAGE TRACKS</h2>
            <div class="track-list" id="trackList">
                <!-- Tracks will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div class="custom-alert-overlay" id="customAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-icon" id="alertIcon">⚠️</div>
            <div class="custom-alert-message" id="alertMessage"></div>
            <button class="custom-alert-btn" id="alertBtn">OK</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc, getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDa5zahCZE7Gsh0JAkC1iimWutpBddRF1s",
            authDomain: "fran-music-cave.firebaseapp.com",
            projectId: "fran-music-cave",
            storageBucket: "fran-music-cave.firebasestorage.app",
            messagingSenderId: "518773964413",
            appId: "1:518773964413:web:46f3b94fb6db076c323b14",
            measurementId: "G-3NN8Q90FX8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.adminDb = db;
        window.adminCollection = collection;
        window.adminQuery = query;
        window.adminOrderBy = orderBy;
        window.adminOnSnapshot = onSnapshot;
        window.adminDoc = doc;
        window.adminDeleteDoc = deleteDoc;
        window.adminGetCountFromServer = getCountFromServer;
    </script>

    <script>
        const ADMIN_PASSWORD = 'fran2025'; // Cambia esto por tu password

        function login() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('adminAuth', 'true');
                showAdminPanel();
            } else {
                customAlert('Incorrect password', '❌');
            }
        }

        function logout() {
            localStorage.removeItem('adminAuth');
            location.reload();
        }

        function showAdminPanel() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminContent').classList.add('active');

            // Wait for Firebase to be ready
            function initAdmin() {
                if (!window.adminDb) {
                    console.log('Waiting for Firebase...');
                    setTimeout(initAdmin, 200);
                    return;
                }
                console.log('Firebase ready, loading data...');
                loadTracks();
                loadStats();
            }

            initAdmin();
        }

        async function loadTracks() {
            if (!window.adminDb) {
                setTimeout(loadTracks, 500);
                return;
            }

            const tracksRef = window.adminCollection(window.adminDb, 'tracks');
            const q = window.adminQuery(tracksRef, window.adminOrderBy('timestamp', 'desc'));

            window.adminOnSnapshot(q, (snapshot) => {
                const trackList = document.getElementById('trackList');
                trackList.innerHTML = '';

                snapshot.forEach((doc) => {
                    const track = doc.data();
                    const trackId = doc.id;

                    const trackDiv = document.createElement('div');
                    trackDiv.className = 'admin-track';
                    trackDiv.innerHTML = `
                        <div class="track-info">
                            <h3>${track.title}</h3>
                            <p>${track.artist}</p>
                            <span class="track-platform-badge">${track.platform.toUpperCase()}</span>
                            <span class="track-platform-badge">Likes: ${track.likes || 0}</span>
                        </div>
                        <button class="delete-btn" onclick="deleteTrack('${trackId}')">DELETE</button>
                    `;
                    trackList.appendChild(trackDiv);
                });
            });
        }

        async function loadStats() {
            if (!window.adminDb) {
                setTimeout(loadStats, 500);
                return;
            }

            try {
                const tracksRef = window.adminCollection(window.adminDb, 'tracks');
                const tracksSnapshot = await window.adminGetCountFromServer(tracksRef);
                document.getElementById('totalTracks').textContent = tracksSnapshot.data().count;

                // Calcular total de likes
                const q = window.adminQuery(tracksRef);
                window.adminOnSnapshot(q, (snapshot) => {
                    let totalLikes = 0;
                    let totalTracks = 0;
                    snapshot.forEach((doc) => {
                        totalLikes += doc.data().likes || 0;
                        totalTracks++;
                    });
                    document.getElementById('totalLikes').textContent = totalLikes;
                    document.getElementById('totalTracks').textContent = totalTracks;
                });

                // Total de comentarios (aproximado)
                document.getElementById('totalComments').textContent = '-';
            } catch (error) {
                console.error('Error loading stats:', error);
                setTimeout(loadStats, 1000);
            }
        }

        async function deleteTrack(trackId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este track?')) return;

            try {
                const trackRef = window.adminDoc(window.adminDb, 'tracks', trackId);
                await window.adminDeleteDoc(trackRef);
                customAlert('Track eliminado exitosamente', '✓');
            } catch (error) {
                console.error('Error deleting track:', error);
                customAlert('Error al eliminar el track', '❌');
            }
        }

        // Check if already logged in
        if (localStorage.getItem('adminAuth') === 'true') {
            showAdminPanel();
        }
    </script>
</body>
</html>
