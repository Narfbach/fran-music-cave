const uploadSection=document.getElementById('uploadSection');const uploadToggle=document.getElementById('uploadToggle');const uploadClose=document.getElementById('uploadClose');const uploadForm=document.getElementById('uploadForm');const uploadSuccess=document.getElementById('uploadSuccess');const trackUrlInput=document.getElementById('trackUrl');const trackTitleInput=document.getElementById('trackTitle');const trackArtistInput=document.getElementById('trackArtist');let metadataTimeout;trackUrlInput.addEventListener('input',()=>{clearTimeout(metadataTimeout);metadataTimeout=setTimeout(async()=>{const url=trackUrlInput.value.trim();if(!url)return;trackTitleInput.placeholder='Loading...';trackArtistInput.placeholder='Loading...';const metadata=await extractMetadata(url);if(metadata){trackTitleInput.value=metadata.title;trackArtistInput.value=metadata.artist;trackTitleInput.placeholder='Track name';trackArtistInput.placeholder='Artist name';}else{trackTitleInput.placeholder='Track name';trackArtistInput.placeholder='Artist name';}},1000);});uploadToggle.addEventListener('click',()=>{if(!window.currentUser){alert('⚠️ Debes estar registrado para subir tracks.\n\nCrea tu cuenta gratis haciendo click en LOGIN y comparte tu música favorita con la comunidad.');return;}
uploadSection.classList.add('active');document.body.style.overflow='hidden';});uploadClose.addEventListener('click',closeUploadModal);uploadSection.addEventListener('click',(e)=>{if(e.target===uploadSection){closeUploadModal();}});function closeUploadModal(){uploadSection.classList.remove('active');document.body.style.overflow='auto';uploadForm.reset();uploadForm.style.display='block';uploadSuccess.classList.remove('active');}
async function extractMetadata(url){try{if(url.includes('spotify.com')){const match=url.match(/track\/([a-zA-Z0-9]+)/);if(match){const trackId=match[1];const oEmbedUrl=`https:const response=await fetch(oEmbedUrl);const data=await response.json();return{title:data.title||'',artist:''};}}
if(url.includes('youtube.com')||url.includes('youtu.be')){let videoId;if(url.includes('youtu.be/')){videoId=url.split('youtu.be/')[1].split('?')[0];}else{const match=url.match(/[?&]v=([^&]+)/);videoId=match?match[1]:null;}
if(videoId){const oEmbedUrl=`https:const response=await fetch(oEmbedUrl);const data=await response.json();const title=data.title;const dashMatch=title.match(/(.*?)\s*[-–—]\s*(.*)/);if(dashMatch){return{title:dashMatch[2].trim(),artist:dashMatch[1].trim()};}else{return{title:title,artist:data.author_name||''};}}}
if(url.includes('soundcloud.com')){const oEmbedUrl=`https:const response=await fetch(oEmbedUrl);const data=await response.json();const title=data.title;const dashMatch=title.match(/(.*?)\s*[-–—]\s*(.*)/);if(dashMatch){return{artist:dashMatch[1].trim(),title:dashMatch[2].trim()};}else{return{title:title,artist:data.author_name||''};}}}catch(error){console.error('Error extracting metadata:',error);}
return null;}
function processTrackUrl(url){if(url.includes('spotify.com')){const match=url.match(/track\/([a-zA-Z0-9]+)/);if(match){return{platform:'spotify',embedUrl:`https:};}}
if(url.includes('youtube.com')||url.includes('youtu.be')){let videoId;if(url.includes('youtu.be/')){videoId=url.split('youtu.be/')[1].split('?')[0];}else{const match=url.match(/[?&]v=([^&]+)/);videoId=match?match[1]:null;}
if(videoId){return{platform:'youtube',embedUrl:`https:};}}
if(url.includes('soundcloud.com')){return{platform:'soundcloud',embedUrl:`https:};}
return null;}
uploadForm.addEventListener('submit',async(e)=>{e.preventDefault();const trackUrl=document.getElementById('trackUrl').value.trim();const trackTitle=document.getElementById('trackTitle').value.trim();const trackArtist=document.getElementById('trackArtist').value.trim();const submitterName=document.getElementById('submitterName').value.trim();const trackData=processTrackUrl(trackUrl);if(!trackData){alert('Invalid URL. Please use Spotify, YouTube or SoundCloud links.');return;}
if(!window.chatDb){alert('Firebase is not configured properly.');return;}
try{const userId=window.currentUser?.uid||null;const username=window.currentUser?.displayName||submitterName||'Anonymous';let isAdmin=false;if(userId){try{const userDoc=await window.chatGetDoc(window.chatDoc(window.chatDb,'users',userId));if(userDoc.exists()){isAdmin=userDoc.data().isAdmin||false;}}catch(error){console.error('Error getting user admin status:',error);}}
await window.chatAddDoc(window.chatCollection(window.chatDb,'tracks'),{title:trackTitle,artist:trackArtist,platform:trackData.platform,embedUrl:trackData.embedUrl,submittedBy:username,userId:userId,isAdmin:isAdmin,timestamp:window.chatServerTimestamp(),likes:0});if(userId){const userRef=window.chatDoc(window.chatDb,'users',userId);const userDoc=await window.chatGetDoc(userRef);if(userDoc.exists()){const currentTracks=userDoc.data().tracksSubmitted||0;const currentScore=userDoc.data().diggerScore||0;await window.chatUpdateDoc(userRef,{tracksSubmitted:currentTracks+1,diggerScore:currentScore+10});}}
uploadForm.style.display='none';uploadSuccess.classList.add('active');setTimeout(()=>{closeUploadModal();},2000);}catch(error){console.error('Error submitting track:',error);alert('Error submitting track. Please try again.');}});
