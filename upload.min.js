const uploadSection=document.getElementById("uploadSection"),uploadToggle=document.getElementById("uploadToggle"),uploadClose=document.getElementById("uploadClose"),uploadForm=document.getElementById("uploadForm"),uploadSuccess=document.getElementById("uploadSuccess");function closeUploadModal(){uploadSection.classList.remove("active"),document.body.style.overflow="auto",uploadForm.reset(),uploadForm.style.display="block",uploadSuccess.classList.remove("active")}function processTrackUrl(e){if(e.includes("spotify.com")){const t=e.match(/track\/([a-zA-Z0-9]+)/);if(t)return{platform:"spotify",embedUrl:`https://open.spotify.com/embed/track/${t[1]}`}}if(e.includes("youtube.com")||e.includes("youtu.be")){let t;if(e.includes("youtu.be/"))t=e.split("youtu.be/")[1].split("?")[0];else{const a=e.match(/[?&]v=([^&]+)/);t=a?a[1]:null}if(t)return{platform:"youtube",embedUrl:`https://www.youtube.com/embed/${t}`}}return e.includes("soundcloud.com")?{platform:"soundcloud",embedUrl:`https://w.soundcloud.com/player/?url=${encodeURIComponent(e)}&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true`}:null}uploadToggle.addEventListener("click",()=>{uploadSection.classList.add("active"),document.body.style.overflow="hidden"}),uploadClose.addEventListener("click",closeUploadModal),uploadSection.addEventListener("click",e=>{e.target===uploadSection&&closeUploadModal()}),uploadForm.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("trackUrl").value.trim(),a=document.getElementById("trackTitle").value.trim(),o=document.getElementById("trackArtist").value.trim(),d=document.getElementById("submitterName").value.trim(),n=processTrackUrl(t);if(!n)return void alert("Invalid URL. Please use Spotify, YouTube or SoundCloud links.");if(!window.chatDb)return void alert("Firebase is not configured properly.");try{const e=window.currentUser?.uid||null,t=window.currentUser?.displayName||d||"Anonymous";await window.chatAddDoc(window.chatCollection(window.chatDb,"tracks"),{title:a,artist:o,platform:n.platform,embedUrl:n.embedUrl,submittedBy:t,userId:e,timestamp:window.chatServerTimestamp(),likes:0}),uploadForm.style.display="none",uploadSuccess.classList.add("active"),setTimeout(()=>{closeUploadModal()},2e3)}catch(e){console.error("Error submitting track:",e),alert("Error submitting track. Please try again.")}});
